name: Daily Joke Update
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯Žæ—¥æœ9æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
  workflow_dispatch:

jobs:
  update-joke:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get random joke or advice and update README
        run: |
          # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒªã‚¹ãƒˆ
          APIS=("https://official-joke-api.appspot.com/jokes/random"
                "https://icanhazdadjoke.com/"
                "https://yomomma-api.herokuapp.com/jokes"
                "https://api.adviceslip.com/advice")

          # ãƒ©ãƒ³ãƒ€ãƒ ã§1ã¤é¸ã¶
          IDX=$((RANDOM % ${#APIS[@]}))
          SELECTED_API="${APIS[$IDX]}"

          echo "Selected API: $SELECTED_API"
          # Acceptãƒ˜ãƒƒãƒ€ãƒ¼å¯¾å¿œ
          if [[ "$SELECTED_API" == "https://icanhazdadjoke.com/" ]]; then
            DATA=$(curl -s -H "Accept: application/json" "$SELECTED_API")
            JOKE=$(echo "$DATA" | jq -r '.joke')
            SETUP=""
            PUNCHLINE="$JOKE"
          elif [[ "$SELECTED_API" == "https://official-joke-api.appspot.com/jokes/random" ]]; then
            DATA=$(curl -s "$SELECTED_API")
            SETUP=$(echo "$DATA" | jq -r '.setup')
            PUNCHLINE=$(echo "$DATA" | jq -r '.punchline')
          elif [[ "$SELECTED_API" == "https://yomomma-api.herokuapp.com/jokes" ]]; then
            DATA=$(curl -s "$SELECTED_API")
            SETUP=""
            PUNCHLINE=$(echo "$DATA" | jq -r '.joke')
          elif [[ "$SELECTED_API" == "https://api.adviceslip.com/advice" ]]; then
            DATA=$(curl -s "$SELECTED_API")
            SETUP=""
            PUNCHLINE=$(echo "$DATA" | jq -r '.slip.advice')
          else
            SETUP=""
            PUNCHLINE="APIã‚¨ãƒ©ãƒ¼"
          fi

          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M')

          cat > README.md << EOF
          # ä»Šæ—¥ã®ä¸€ç™ºãƒã‚¿ãƒ»ã‚¸ãƒ§ãƒ¼ã‚¯ ðŸ˜„

          $SETUP

          **$PUNCHLINE**

          ---
          - ã‚½ãƒ¼ã‚¹API: $SELECTED_API
          - æœ€çµ‚æ›´æ–°: $CURRENT_DATE

          ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯æ¯Žæ—¥æœ9æ™‚ã«è‡ªå‹•ã§è‹±èªžã®ã‚¸ãƒ§ãƒ¼ã‚¯ã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã™ï¼
          GitHub Actionsã®åŠ›ã§ã€365æ—¥é•ã£ãŸæ–‡ç« ã«å‡ºä¼šãˆã¾ã™ã€‚
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ðŸ“ ä»Šæ—¥ã®ã‚¸ãƒ§ãƒ¼ã‚¯ã‚’æ›´æ–°: $(date '+%Y-%m-%d')" || echo "No changes to commit"
          git push
